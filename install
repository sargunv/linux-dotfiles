#!/bin/bash
set -euo pipefail

cd "$(dirname "$0")"

if [ -f /etc/apt/sources.list ]; then
    echo
    echo 'ðŸ“¦ Updating apt package lists ...'
    sudo apt-get update

    echo
    echo 'ðŸ“¦ Installing apt packages ...'
    grep -v '^#' ./apt-packages.txt | xargs sudo apt-get install -y
fi

echo
echo 'ðŸ“¦ Installing Brew packages ...'
/home/linuxbrew/.linuxbrew/bin/brew bundle --no-lock --quiet

echo
echo 'ðŸ”— Linking dotfiles ...'
function link_dotfile() {
    src="$(realpath "$0")"
    dst="$HOME/$(realpath --relative-to=./dotfiles "$0")"
    echo "Linking $dst"
    mkdir -p "$(dirname "$dst")"
    ln -fs "$src" "$dst"
}
export -f link_dotfile
find ./dotfiles -type f -exec bash -c 'link_dotfile "$0"' {} \;

echo
echo 'ðŸ“„ Downloading global gitignore ...'
wget -qO ~/.gitignore_global 'https://raw.githubusercontent.com/github/gitignore/main/Global/Linux.gitignore'

source ~/.profile

echo
echo 'ðŸ”Œ Installing asdf plugins ...'
(asdf plugin add nodejs 'https://github.com/asdf-vm/asdf-nodejs.git') || true
(asdf plugin add python) || true

echo
echo 'ðŸ”Œ Installing asdf versions ...'
xargs -a ~/.tool-versions -n2 asdf install

echo
echo 'ðŸŽ‰ Done!'
